require "spec_helper"

RSpec.describe VisionUtils do
  let(:utils) { described_class }

  let(:raw_response) do
    # rubocop:disable LineLength
    "{\"responses\":[{\"textAnnotations\":[{\"locale\":\"en\",\"description\":\"ERROR:\\nwww 418: I'm a teapot\\n\",\"boundingPoly\":{\"vertices\":[{\"x\":77,\"y\":157},{\"x\":735,\"y\":157},{\"x\":735,\"y\":288},{\"x\":77,\"y\":288}]}},{\"description\":\"ERROR\",\"boundingPoly\":{\"vertices\":[{\"x\":434,\"y\":157},{\"x\":679,\"y\":157},{\"x\":679,\"y\":231},{\"x\":434,\"y\":231}]}},{\"description\":\":\",\"boundingPoly\":{\"vertices\":[{\"x\":707,\"y\":157},{\"x\":728,\"y\":157},{\"x\":728,\"y\":231},{\"x\":707,\"y\":231}]}},{\"description\":\"www\",\"boundingPoly\":{\"vertices\":[{\"x\":77,\"y\":226},{\"x\":165,\"y\":226},{\"x\":165,\"y\":288},{\"x\":77,\"y\":288}]}},{\"description\":\"418\",\"boundingPoly\":{\"vertices\":[{\"x\":218,\"y\":226},{\"x\":315,\"y\":226},{\"x\":315,\"y\":288},{\"x\":218,\"y\":288}]}},{\"description\":\":\",\"boundingPoly\":{\"vertices\":[{\"x\":334,\"y\":226},{\"x\":351,\"y\":226},{\"x\":351,\"y\":288},{\"x\":334,\"y\":288}]}},{\"description\":\"I\",\"boundingPoly\":{\"vertices\":[{\"x\":378,\"y\":226},{\"x\":395,\"y\":226},{\"x\":395,\"y\":288},{\"x\":378,\"y\":288}]}},{\"description\":\"'\",\"boundingPoly\":{\"vertices\":[{\"x\":403,\"y\":226},{\"x\":420,\"y\":226},{\"x\":420,\"y\":288},{\"x\":403,\"y\":288}]}},{\"description\":\"m\",\"boundingPoly\":{\"vertices\":[{\"x\":435,\"y\":226},{\"x\":452,\"y\":226},{\"x\":452,\"y\":288},{\"x\":435,\"y\":288}]}},{\"description\":\"a\",\"boundingPoly\":{\"vertices\":[{\"x\":498,\"y\":226},{\"x\":515,\"y\":226},{\"x\":515,\"y\":288},{\"x\":498,\"y\":288}]}},{\"description\":\"teapot\",\"boundingPoly\":{\"vertices\":[{\"x\":544,\"y\":226},{\"x\":735,\"y\":226},{\"x\":735,\"y\":288},{\"x\":544,\"y\":288}]}}],\"fullTextAnnotation\":{\"pages\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\",\"confidence\":1}]},\"width\":770,\"height\":300,\"blocks\":[{\"boundingBox\":{\"vertices\":[{\"x\":77,\"y\":157},{\"x\":735,\"y\":157},{\"x\":735,\"y\":288},{\"x\":77,\"y\":288}]},\"paragraphs\":[{\"boundingBox\":{\"vertices\":[{\"x\":77,\"y\":157},{\"x\":735,\"y\":157},{\"x\":735,\"y\":288},{\"x\":77,\"y\":288}]},\"words\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":434,\"y\":157},{\"x\":679,\"y\":157},{\"x\":679,\"y\":231},{\"x\":434,\"y\":231}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":434,\"y\":157},{\"x\":477,\"y\":157},{\"x\":477,\"y\":231},{\"x\":434,\"y\":231}]},\"text\":\"E\",\"confidence\":0.99},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":487,\"y\":157},{\"x\":529,\"y\":157},{\"x\":529,\"y\":231},{\"x\":487,\"y\":231}]},\"text\":\"R\",\"confidence\":0.99},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":540,\"y\":157},{\"x\":580,\"y\":157},{\"x\":580,\"y\":231},{\"x\":540,\"y\":231}]},\"text\":\"R\",\"confidence\":1},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":585,\"y\":157},{\"x\":625,\"y\":157},{\"x\":625,\"y\":231},{\"x\":585,\"y\":231}]},\"text\":\"O\",\"confidence\":1},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":637,\"y\":157},{\"x\":679,\"y\":157},{\"x\":679,\"y\":231},{\"x\":637,\"y\":231}]},\"text\":\"R\",\"confidence\":1}],\"confidence\":0.99},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":707,\"y\":157},{\"x\":728,\"y\":157},{\"x\":728,\"y\":231},{\"x\":707,\"y\":231}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}],\"detectedBreak\":{\"type\":\"EOL_SURE_SPACE\"}},\"boundingBox\":{\"vertices\":[{\"x\":707,\"y\":157},{\"x\":728,\"y\":157},{\"x\":728,\"y\":231},{\"x\":707,\"y\":231}]},\"text\":\":\",\"confidence\":1}],\"confidence\":1},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":77,\"y\":226},{\"x\":165,\"y\":226},{\"x\":165,\"y\":288},{\"x\":77,\"y\":288}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":77,\"y\":226},{\"x\":92,\"y\":226},{\"x\":92,\"y\":288},{\"x\":77,\"y\":288}]},\"text\":\"w\",\"confidence\":0.17},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":91,\"y\":226},{\"x\":116,\"y\":226},{\"x\":116,\"y\":288},{\"x\":91,\"y\":288}]},\"text\":\"w\",\"confidence\":0.27},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}],\"detectedBreak\":{\"type\":\"SPACE\"}},\"boundingBox\":{\"vertices\":[{\"x\":130,\"y\":226},{\"x\":165,\"y\":226},{\"x\":165,\"y\":288},{\"x\":130,\"y\":288}]},\"text\":\"w\",\"confidence\":0.06}],\"confidence\":0.16},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":218,\"y\":226},{\"x\":315,\"y\":226},{\"x\":315,\"y\":288},{\"x\":218,\"y\":288}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":218,\"y\":226},{\"x\":253,\"y\":226},{\"x\":253,\"y\":288},{\"x\":218,\"y\":288}]},\"text\":\"4\",\"confidence\":0.74},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":265,\"y\":226},{\"x\":293,\"y\":226},{\"x\":293,\"y\":288},{\"x\":265,\"y\":288}]},\"text\":\"1\",\"confidence\":0.8},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":294,\"y\":226},{\"x\":315,\"y\":226},{\"x\":315,\"y\":288},{\"x\":294,\"y\":288}]},\"text\":\"8\",\"confidence\":0.79}],\"confidence\":0.77},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":334,\"y\":226},{\"x\":351,\"y\":226},{\"x\":351,\"y\":288},{\"x\":334,\"y\":288}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}],\"detectedBreak\":{\"type\":\"SPACE\"}},\"boundingBox\":{\"vertices\":[{\"x\":334,\"y\":226},{\"x\":351,\"y\":226},{\"x\":351,\"y\":288},{\"x\":334,\"y\":288}]},\"text\":\":\",\"confidence\":0.8}],\"confidence\":0.8},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":378,\"y\":226},{\"x\":395,\"y\":226},{\"x\":395,\"y\":288},{\"x\":378,\"y\":288}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":378,\"y\":226},{\"x\":395,\"y\":226},{\"x\":395,\"y\":288},{\"x\":378,\"y\":288}]},\"text\":\"I\",\"confidence\":0.93}],\"confidence\":0.93},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":403,\"y\":226},{\"x\":420,\"y\":226},{\"x\":420,\"y\":288},{\"x\":403,\"y\":288}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":403,\"y\":226},{\"x\":420,\"y\":226},{\"x\":420,\"y\":288},{\"x\":403,\"y\":288}]},\"text\":\"'\",\"confidence\":0.91}],\"confidence\":0.91},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":435,\"y\":226},{\"x\":452,\"y\":226},{\"x\":452,\"y\":288},{\"x\":435,\"y\":288}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}],\"detectedBreak\":{\"type\":\"SPACE\"}},\"boundingBox\":{\"vertices\":[{\"x\":435,\"y\":226},{\"x\":452,\"y\":226},{\"x\":452,\"y\":288},{\"x\":435,\"y\":288}]},\"text\":\"m\",\"confidence\":0.85}],\"confidence\":0.85},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":498,\"y\":226},{\"x\":515,\"y\":226},{\"x\":515,\"y\":288},{\"x\":498,\"y\":288}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}],\"detectedBreak\":{\"type\":\"SPACE\"}},\"boundingBox\":{\"vertices\":[{\"x\":498,\"y\":226},{\"x\":515,\"y\":226},{\"x\":515,\"y\":288},{\"x\":498,\"y\":288}]},\"text\":\"a\",\"confidence\":0.94}],\"confidence\":0.94},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":544,\"y\":226},{\"x\":735,\"y\":226},{\"x\":735,\"y\":288},{\"x\":544,\"y\":288}]},\"symbols\":[{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":544,\"y\":226},{\"x\":570,\"y\":226},{\"x\":570,\"y\":288},{\"x\":544,\"y\":288}]},\"text\":\"t\",\"confidence\":0.93},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":576,\"y\":226},{\"x\":601,\"y\":226},{\"x\":601,\"y\":288},{\"x\":576,\"y\":288}]},\"text\":\"e\",\"confidence\":0.93},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":607,\"y\":226},{\"x\":633,\"y\":226},{\"x\":633,\"y\":288},{\"x\":607,\"y\":288}]},\"text\":\"a\",\"confidence\":0.99},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":639,\"y\":226},{\"x\":664,\"y\":226},{\"x\":664,\"y\":288},{\"x\":639,\"y\":288}]},\"text\":\"p\",\"confidence\":0.99},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}]},\"boundingBox\":{\"vertices\":[{\"x\":669,\"y\":226},{\"x\":697,\"y\":226},{\"x\":697,\"y\":288},{\"x\":669,\"y\":288}]},\"text\":\"o\",\"confidence\":0.99},{\"property\":{\"detectedLanguages\":[{\"languageCode\":\"en\"}],\"detectedBreak\":{\"type\":\"LINE_BREAK\"}},\"boundingBox\":{\"vertices\":[{\"x\":705,\"y\":226},{\"x\":735,\"y\":226},{\"x\":735,\"y\":288},{\"x\":705,\"y\":288}]},\"text\":\"t\",\"confidence\":1}],\"confidence\":0.97}],\"confidence\":0.82}],\"blockType\":\"TEXT\",\"confidence\":0.82}]}],\"text\":\"ERROR:\\nwww 418: I'm a teapot\\n\"}}]}"
    # rubocop:enable LineLength
  end

  before do
    stub_request(
      :post, "https://vision.googleapis.com/v1/images:annotate?key=test_key"
    ).with(
      body: {
        'requests' => [
          'image' => { 'source' => { 'imageUri' => 'http://teapot.err' } },
          'features' => [
            { 'type' => 'DOCUMENT_TEXT_DETECTION' }
          ]
        ]
      }.to_json
    ).to_return(body: raw_response)
  end

  describe "#get_word_layout" do
    it "returns the words, their location and confidence level" do
      result = utils.get_word_layout('http://teapot.err', 'test_key')
      expect(result.count).to eq 10
      expect(result.last).to eq ["teapot", [[544, 226], [735, 226], [735, 288], [544, 288]], 0.93]
    end
  end

  context "when image has no words" do
    let(:raw_response) do
      "{\"responses\":[{}]}"
    end

    it "returns an empty word array" do
      result = utils.get_word_layout('http://teapot.err', 'test_key')
      expect(result.count).to eq 0
    end
  end
end
